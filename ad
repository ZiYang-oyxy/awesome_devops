#!/bin/bash
#
# Awesome Devops (or yet another AirDrop)
#
# Copyright © 2021 Ouyang Xiongyi. All Rights Reserved.
#

CURDIR="`dirname $(readlink -f $0)`"
source $CURDIR/lib/common.sh

if [[ -n "$LR" ]]; then
    CURL="curl --limit-rate $LR"
else
    CURL="curl"
fi

put()
{
    if [[ ! -f $1 ]]; then
        cecho -R "No such file"
        exit 1
    fi
    _name=`basename $1`
    _r_file=${2:-$_name}
    $CURL -T $1 $PUTURL/$_r_file > /dev/null
    if [[ $? -eq 0 ]]; then
        _res=(`md5sum $1`)
        cecho -Y "${_res[0]}"
        cecho -G "$GETURL/$_r_file"
        cecho -M "ad get $_r_file"
    fi
}

# [Comparison of Compression Algorithms]
# https://linuxreviews.org/Comparison_of_Compression_Algorithms
dput()
{
    # “:”会被tar认为是远程服务器
    if [[ $1 =~ .*:.* ]]; then
        cecho -R "not allow directory contain \":\""
        exit 1
    fi
    if [[ ! -d $1 ]]; then
        cecho -R "No such directory"
        exit 1
    fi
    _name=`basename $1`
    _parent=`dirname $1`
    if (type pigz >/dev/null 2>&1); then
        tar c -C $_parent --exclude='.git' -f - $_name | pigz > $_name.tgz
    else
        tar c -C $_parent --exclude='.git' -z -f $_name.tgz $_name
    fi
    $CURL -T $_name.tgz $PUTURL/$_name.tgz > /dev/null
    if [[ $? -eq 0 ]]; then
        _res=(`md5sum $_name.tgz`)
        cecho -Y "${_res[0]}"
        cecho -G "$GETURL/$_name.tgz"
        cecho -M "ad dget $_name"
    fi
    rm $_name.tgz
}

# [Comparison of Compression Algorithms]
# https://linuxreviews.org/Comparison_of_Compression_Algorithms
dgput()
{
    # “:”会被tar认为是远程服务器
    if [[ $1 =~ .*:.* ]]; then
        cecho -R "not allow directory contain \":\""
        exit 1
    fi
    if [[ ! -d $1 ]]; then
        cecho -R "No such directory"
        exit 1
    fi
    _name=`basename $1`
    _parent=`dirname $1`
    if (type pigz >/dev/null 2>&1); then
        tar c -C $_parent -f - $_name | pigz > $_name.tgz
    else
        tar c -C $_parent -z -f $_name.tgz $_name
    fi
    $CURL -T $_name.tgz $PUTURL/$_name.tgz > /dev/null
    if [[ $? -eq 0 ]]; then
        _res=(`md5sum $_name.tgz`)
        cecho -Y "${_res[0]}"
        cecho -G "$GETURL/$_name.tgz"
        cecho -M "ad dget $_name"
    fi
    rm $_name.tgz
}

tput()
{
    if [[ ! -f $1 ]]; then
        cecho -R "No such file"
        exit 1
    fi
    _name=`basename $1`
    _r_file=`date '+%Y-%m-%d_%H-%M-%S'`_${2:-$_name}
    $CURL -T $1 $PUTURL/$_r_file > /dev/null
    if [[ $? -eq 0 ]]; then
        _res=(`md5sum $1`)
        cecho -Y "${_res[0]}"
        cecho -G "$GETURL/$_r_file"
        cecho -M "ad get $_r_file"
    fi
}

get()
{
    _l_file=${2:-$1}
    temp_file="${_l_file}.download"
    if ! $CURL -fo "$temp_file" "$GETURL/$1"; then
        rm -f "$temp_file"
        cecho -R "Download failed"
        exit 1
    fi

    owner=""
    if [ -f "$_l_file" ]; then
        owner=$(stat -c "%U:%G" "$_l_file")
        permissions=$(stat -c "%a" "$_l_file")
    fi
    mv -f "$temp_file" "$_l_file"
    if [[ -n $owner ]]; then
        chown "$owner" "$_l_file"
        chmod "$permissions" "$_l_file"
    fi
    _res=(`md5sum "$_l_file"`)
    cecho -Y "${_res[0]}"
    cecho -G "$(readlink -f "$_l_file")"
}

dget()
{
    # “:”会被tar认为是远程服务器
    if [[ "$1" == *":"* ]]; then
        cecho -R 'filename must not contain ":"'
        exit 1
    fi

    _file_path="$1.tgz"
    _temp_file_path="${_file_path}.download"

    if $CURL -fo "$_temp_file_path" "$GETURL/$_file_path"; then
        mv -f "$_temp_file_path" "$_file_path"
        tar -x -o -f "$_file_path"
        cecho -Y "$(md5sum "$_file_path" | awk '{print $1}')"
        cecho -G "$(readlink -f "$1")"
        rm "$_file_path"
    else
        rm -f "$_temp_file_path"
        cecho -R "Download failed"
        exit 1
    fi
}

upgrade()
{
    bash <($CURL -s $GETURL/@aadi@)
}

ad_tree()
{
    tree -C $CURDIR -I '.git|vim' -L 3
}

vim_init()
{
    if [ -d $CURDIR/.git ]; then
        return
    fi
    ad cecho -g "ad vim initialize ..."
    cd $CURDIR/
    ad get @vim_bundle.tgz@
    tar xf @vim_bundle.tgz@
    _vim_ver=`vim --version | awk '/Vi IMproved / {print $5}'`
    # 非arm（macos），并且支持版本很低，这使用预制vim
    if [[ $(echo "$_vim_ver < 9.0" | bc -l) ]] && [[ ! $(vim --version | grep -q arm64) ]]; then
        ad get @vim9.0_x86@ vim/vim
        chmod +x vim/vim
        ad get @vimdiff9.0_x86@ vim/vimdiff
        chmod +x vim/vimdiff
        # 从 /usr/local/share/vim/vim90 中获得
        ad get @vim90_x86.tgz@
        tar xf @vim90_x86.tgz@
        mv vim90 vim/vim90
        echo "export VIMRUNTIME=~/.awesome_devops/vim/vim90" > vim/.env
    fi
    touch vim/.env
    cd -
}

ad_vim()
{
    [ ! -f $CURDIR/vim/.env ] && vim_init
    [ ! -f $CURDIR/vim/.env ] || source $CURDIR/vim/.env
    if [ -f $CURDIR/vim/vim ]; then
        $CURDIR/vim/vim -u $CURDIR/vim/.vimrc "$@"
    else
        vim -u $CURDIR/vim/.vimrc "$@"
    fi
}

ad_vimdiff()
{
    [ ! -f $CURDIR/vim/.env ] && vim_init
    [ ! -f $CURDIR/vim/.env ] || source $CURDIR/vim/.env
    if [ -f $CURDIR/vim/vimdiff ]; then
        $CURDIR/vim/vimdiff -u $CURDIR/vim/.vimrc "$@"
    else
        vimdiff -u $CURDIR/vim/.vimrc "$@"
    fi
}

uninstall()
{
    rm -f ~/tmp/awesome_devops.tar ~/bin/ad
    rm -rf ~/.awesome_devops ~/.awesome_devops.bak
    sed -i '/ad-completion.bash/d' ~/.bashrc
    sed -i '/@ad_plugins@/d' ~/.bashrc
    echo "uninstall success"
}

new_version_detect()
{
    _old=`cat $CURDIR/latest_version`
    _new=`$CURL --connect-timeout 1 -f $GETURL/'@latest_version@' 2>/dev/null`

    if [[ ! $? -eq 0 ]]; then
        cecho -Gy 'Unable to connect to ad server'
    fi

    if [[ $_new -gt $_old ]]; then
        cecho -g 'A new version is available! Run "ad upgrade"'
    fi
}

usage(){

    cat <<__EOF__

⚙ Awesome Devops (or yet another AirDrop) ⚙

Usage:  ad [ COMMAND | TOOL | PLUGIN ] [ ARGUMENT ]

    BASIC COMMAND:
        help      # this message
        upgrade   # upgrade to latest version
        uninstall # leave no trace
        vim       # my vim
        tree      # prints out ad directory in a tree-like display
        [ put | tput | get ] <file>
        [ dput | dgput | dget ] <directory>

    TOOL:
__EOF__
    for i in `ls $CURDIR/tools/`; do
        if [[ -d $CURDIR/tools/$i ]]; then
            echo "        $i/"
        else
            echo "        $i"
        fi
    done

    cat <<__EOF__

    EXTERNAL TOOL:
__EOF__
    for i in `ls $CURDIR/ext_tools/`; do
        if [[ -d $CURDIR/ext_tools/$i ]]; then
            echo "        $i/"
        else
            echo "        $i"
        fi
    done

    cat <<__EOF__

    PLUGIN install:
__EOF__
    for i in `ls $CURDIR/plugins/`; do
        echo "        deploy ${i##*/}"
    done

    cat <<__EOF__

Upload link:
$PUTURL

Install or Upgrade:
bash <(curl -s $GETURL/@aadi@) && source ~/.bashrc

Home page:
$SERVEFILE_URL
__EOF__

    new_version_detect

    [ "$_action" == "help" ] && exit 0 || exit 1
}

_action=$1; shift;

if [[ -z $_action ]]; then
    usage
    exit 1
fi

case $_action in
    put | get | dput | dgput | dget | tput | upgrade | uninstall)
        $_action "$@"
        ;;
    help)
        usage
        ;;
    tree)
        ad_tree
        ;;
    vim)
        ad_vim "$@"
        ;;
    vimdiff)
        ad_vimdiff "$@"
        ;;
    deploy)
        _plugin=$1
        if [[ -z $_plugin ]]; then
            cecho -R "no plugin is specified! Select one:"
            for i in `ls $CURDIR/plugins/`; do
                echo "${i##*/}"
            done
            exit 1
        fi
        shift
        $CURDIR/plugins/$_plugin/install $@
        ;;
    ex)
        # install my experimental tool, will not be displayed in usage
        $CURDIR/experimental/$1/install
        ;;
    *)
        # 无目录工具，直接执行
        if [[ -f $CURDIR/tools/$_action ]]; then
            $CURDIR/tools/$_action "$@"
        elif [[ -f $CURDIR/ext_tools/$_action ]]; then
            $CURDIR/ext_tools/$_action "$@"
        # 有目录工具，目录与工具名必须同名，直接执行
        elif [[ -f $CURDIR/tools/$_action/$_action ]]; then
            $CURDIR/tools/$_action/$_action "$@"
        elif [[ -f $CURDIR/ext_tools/$_action/$_action ]]; then
            $CURDIR/ext_tools/$_action/$_action "$@"
        # 有目录工具，目录与工具名不同名，一般是一个工具集，展示命令列表，或直接执行
        elif [[ -d $CURDIR/tools/$_action ]]; then
            _tool=$1
            if [[ -z $_tool ]]; then
                echo "Tool List:"
                _list=`find $CURDIR/tools/$_action/ -maxdepth 1 -perm -111 -type f`
                cecho -G "$_list"
            else
                shift
                $CURDIR/tools/$_action/$_tool "$@"
            fi
        elif [[ -d $CURDIR/ext_tools/$_action ]]; then
            _tool=$1
            if [[ -z $_tool ]]; then
                echo "Tool List:"
                _list=`find $CURDIR/ext_tools/$_action/ -maxdepth 1 -perm -111 -type f`
                cecho -G "$_list"
            else
                shift
                $CURDIR/ext_tools/$_action/$_tool "$@"
            fi
        else
            usage
            exit 1
        fi
        ;;
esac
