#!/bin/bash
#
# Awesome Devops (or yet another AirDrop)
#
# TODO
# - (p1) 支持mac命令行工具
# - (p0) 支持bash completion
# - (p2) ad put无法传空文件

_curdir="`dirname $(readlink -f $0)`"
source $_curdir/lib/common.sh

_puturl="http://10.145.17.12:8889"
_geturl="http://10.145.17.12:8890"

put()
{
    _name=`basename $1`
    _r_file=${2:-$_name}
    curl -T $1 $_puturl/$_r_file > /dev/null
    if [[ $? -eq 0 ]]; then
        md5sum $1
        cecho g "$_geturl/$_r_file"
    fi
}

get()
{
    _name=`basename $1`
    _l_file=${2:-$_name}
    curl -o $_l_file $_geturl/$_name
    md5sum $_l_file
    cecho g "`readlink -f $_l_file`"
}

upgrade()
{
    sh $_curdir/install.sh
}

usage(){

    cat <<__EOF__

⚙ Awesome Devops (or yet another AirDrop) ⚙

Install:
bash <(curl -s $_geturl/@aadi@) && source ~/.bashrc

Usage:  ad [ PLUGIN | COMMAND ] [help]

    PLUGIN deploy:
__EOF__
    for i in `ls $_curdir/plugins/`; do
        echo "        ${i##*/}"
    done

cat <<__EOF__

    COMMANDS:
        help
        put
        get
        upgrade
__EOF__
    for i in `ls $_curdir/tools/`; do
        echo "        ${i##*/}"
    done

    [ "$_action" == "help" ] && exit 0 || exit 1
}

_action=$1; shift;

if [[ -z $_action ]]; then
    usage
    exit 1
fi

if [[ -d $_curdir/plugins/$_action ]]; then
    $_curdir/plugins/$_action/install
else
    case $_action in
        put)
            put "$@"
            ;;
        get)
            get "$@"
            ;;
        help)
            usage
            ;;
        upgrade)
            upgrade
            ;;
        *)
            # 无目录工具，支持直接执行
            if [[ -f $_curdir/tools/$_action ]]; then
                $_curdir/tools/$_action "$@"
            # 有目录工具，目录与工具名必须同名，支持直接执行
            elif [[ -f $_curdir/tools/$_action/$_action ]]; then
                $_curdir/tools/$_action/$_action "$@"
            # 有目录工具，目录与工具名不同名，不支持直接执行
            elif [[ -d $_curdir/tools/$_action ]]; then
                echo "Tool List:"
                _list=`find $_curdir/tools/$_action/ -maxdepth 1 -perm -111 -type f`
                cecho g "$_list"
            else
                usage
                exit 1
            fi
            ;;
    esac
fi
