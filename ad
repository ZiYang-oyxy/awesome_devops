#!/bin/bash
#
# Awesome Devops (or yet another AirDrop)
#
# Copyright © 2021 Ouyang Xiongyi. All Rights Reserved.
#
# TODO
# - (p0) 支持bash completion
# - (p0) 搞定rsync
# - (p1) 兼容macOS非gnu版本工具

_curdir="`dirname $(readlink -f $0)`"
source $_curdir/lib/common.sh

put()
{
    if [[ ! -f $1 ]]; then
        cecho r "No such file"
        exit 1
    fi
    _name=`basename $1`
    _r_file=${2:-$_name}
    curl -T $1 $PUTURL/$_r_file > /dev/null
    if [[ $? -eq 0 ]]; then
        _res=(`md5sum $1`)
        cecho y "${_res[0]}"
        cecho g "$GETURL/$_r_file"
        cecho p "ad get $_r_file"
    fi
}

# [Comparison of Compression Algorithms]
# https://linuxreviews.org/Comparison_of_Compression_Algorithms
dput()
{
    if [[ ! -d $1 ]]; then
        cecho r "No such directory"
        exit 1
    fi
    _name=`basename $1`
    _parent=`dirname $1`
    if (type pigz >/dev/null 2>&1); then
        tar c -C $_parent --exclude='.git' -f - $_name | pigz > $_name.tgz
    else
        tar c -C $_parent --exclude='.git' -zf $_name.tgz $_name
    fi
    curl -T $_name.tgz $PUTURL/$_name.tgz > /dev/null
    if [[ $? -eq 0 ]]; then
        _res=(`md5sum $_name.tgz`)
        cecho y "${_res[0]}"
        cecho g "$GETURL/$_name.tgz"
        cecho p "ad dget $_name"
    fi
    rm $_name.tgz
}

tput()
{
    if [[ ! -f $1 ]]; then
        cecho r "No such file"
        exit 1
    fi
    _name=`basename $1`
    _r_file=`date --iso-8601=seconds`_${2:-$_name}
    curl -T $1 $PUTURL/$_r_file > /dev/null
    if [[ $? -eq 0 ]]; then
        _res=(`md5sum $1`)
        cecho y "${_res[0]}"
        cecho g "$GETURL/$_r_file"
        cecho p "ad get $_r_file"
    fi
}

get()
{
    _l_file=${2:-$1}
    curl -fo $_l_file $GETURL/$1
    if [[ ! $? -eq 0 ]]; then
        rm -f $_l_file
        cecho r "No such file"
        exit 1
    fi
    _res=(`md5sum $_l_file`)
    cecho y "${_res[0]}"
    cecho g "`readlink -f $_l_file`"
}

dget()
{
    curl -fo $1.tgz $GETURL/$1.tgz
    if [[ ! $? -eq 0 ]]; then
        rm -f $1.tgz
        cecho r "No such directory"
        exit 1
    fi
    tar xf $1.tgz
    _res=(`md5sum $1.tgz`)
    cecho y "${_res[0]}"
    cecho g "`readlink -f $1`"
    rm $1.tgz
}

upgrade()
{
    sh $_curdir/install.sh
}

new_version_detect()
{
    _old=`cat $_curdir/latest_version`
    _new=`curl --connect-timeout 1 -f $GETURL/'@latest_version@' 2>/dev/null`

    if [[ ! $? -eq 0 ]]; then
        cecho gr 'Unable to connect to ad server'
    fi

    if [[ $_new -gt $_old ]]; then
        cecho gr 'A new version is available! Run "ad upgrade"'
    fi
}

usage(){

    cat <<__EOF__

⚙ Awesome Devops (or yet another AirDrop) ⚙

Usage:  ad [ PLUGIN | COMMAND ] [help]

    PLUGIN deploy:
__EOF__
    for i in `ls $_curdir/plugins/`; do
        echo "        ${i##*/}"
    done

    cat <<__EOF__

    COMMANDS:
        help
        put | dput | tput
        get | dget
        upgrade
__EOF__
    for i in `ls $_curdir/tools/`; do
        echo "        ${i##*/}"
    done

    cat <<__EOF__

Web browser upload link:
$PUTURL

Install or Upgrade:
bash <(curl -s $GETURL/@aadi@) && source ~/.bashrc

Bug report:
ruliu to ouyangxiongyi
__EOF__

    new_version_detect

    [ "$_action" == "help" ] && exit 0 || exit 1
}

_action=$1; shift;

if [[ -z $_action ]]; then
    usage
    exit 1
fi

# use experimental tool
if [[ $_action == "ex" ]]; then
    $_curdir/experimental/$1/install
    exit 0
fi

if [[ -d $_curdir/plugins/$_action ]]; then
    $_curdir/plugins/$_action/install
else
    case $_action in
        put | get | dput | dget | tput)
            $_action "$@"
            ;;
        help)
            usage
            ;;
        upgrade)
            upgrade
            ;;
        *)
            # 无目录工具，直接执行
            if [[ -f $_curdir/tools/$_action ]]; then
                $_curdir/tools/$_action "$@"
            # 有目录工具，目录与工具名必须同名，直接执行
            elif [[ -f $_curdir/tools/$_action/$_action ]]; then
                $_curdir/tools/$_action/$_action "$@"
            # 有目录工具，目录与工具名不同名，一般是一个工具集，展示命令列表
            elif [[ -d $_curdir/tools/$_action ]]; then
                echo "Tool List:"
                _list=`find $_curdir/tools/$_action/ -maxdepth 1 -perm -111 -type f`
                cecho g "$_list"
            else
                usage
                exit 1
            fi
            ;;
    esac
fi
