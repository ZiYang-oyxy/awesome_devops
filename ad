#!/bin/bash
#
# Awesome Devops (or yet another AirDrop)
#
# Copyright © 2021 Ouyang Xiongyi. All Rights Reserved.
#
# TODO
# - (p0) 支持bash completion
# - (p1) 兼容macOS非gnu版本工具

_curdir="`dirname $(readlink -f $0)`"
source $_curdir/lib/common.sh

_puturl="http://10.145.17.12:8889"
_geturl="http://10.145.17.12:8890"

put()
{
    if [[ ! -f $1 ]]; then
        cecho r "No such file"
        exit 1
    fi
    _name=`basename $1`
    _r_file=${2:-$_name}
    curl -T $1 $_puturl/$_r_file > /dev/null
    if [[ $? -eq 0 ]]; then
        md5sum $1
        cecho g "$_geturl/$_r_file"
    fi
}

# [Comparison of Compression Algorithms]
# https://linuxreviews.org/Comparison_of_Compression_Algorithms
dput()
{
    if [[ ! -d $1 ]]; then
        cecho r "No such directory"
        exit 1
    fi
    _name=`basename $1`
    _parent=`dirname $1`
    if (type pigz >/dev/null 2>&1); then
        tar c -C $_parent -f - $_name | pigz > $_name.tgz
    else
        tar c -C $_parent -zf $_name.tgz $_name
    fi
    curl -T $_name.tgz $_puturl/$_name.tgz > /dev/null
    if [[ $? -eq 0 ]]; then
        md5sum $_name.tgz
        cecho g "$_geturl/$_name.tgz"
    fi
    rm $_name.tgz
}

get()
{
    _l_file=${2:-$1}
    curl -fo $_l_file $_geturl/$1
    if [[ ! $? -eq 0 ]]; then
        rm -f $_l_file
        cecho r "No such file"
        exit 1
    fi
    md5sum $_l_file
    cecho g "`readlink -f $_l_file`"
}

dget()
{
    curl -fo $1.tgz $_geturl/$1.tgz
    if [[ ! $? -eq 0 ]]; then
        rm -f $1.tgz
        cecho r "No such directory"
        exit 1
    fi
    tar xf $1.tgz
    md5sum $1.tgz
    cecho g "`readlink -f $1`"
    rm $1.tgz
}

upgrade()
{
    sh $_curdir/install.sh
}

usage(){

    cat <<__EOF__

⚙ Awesome Devops (or yet another AirDrop) ⚙

Install:
bash <(curl -s $_geturl/@aadi@) && source ~/.bashrc

Usage:  ad [ PLUGIN | COMMAND ] [help]

    PLUGIN deploy:
__EOF__
    for i in `ls $_curdir/plugins/`; do
        echo "        ${i##*/}"
    done

cat <<__EOF__

    COMMANDS:
        help
        put
        get
        upgrade
__EOF__
    for i in `ls $_curdir/tools/`; do
        echo "        ${i##*/}"
    done

    [ "$_action" == "help" ] && exit 0 || exit 1
}

_action=$1; shift;

if [[ -z $_action ]]; then
    usage
    exit 1
fi

if [[ -d $_curdir/plugins/$_action ]]; then
    $_curdir/plugins/$_action/install
else
    case $_action in
        put)
            put "$@"
            ;;
        get)
            get "$@"
            ;;
        dput)
            dput "$@"
            ;;
        dget)
            dget "$@"
            ;;
        help)
            usage
            ;;
        upgrade)
            upgrade
            ;;
        *)
            # 无目录工具，支持直接执行
            if [[ -f $_curdir/tools/$_action ]]; then
                $_curdir/tools/$_action "$@"
            # 有目录工具，目录与工具名必须同名，支持直接执行
            elif [[ -f $_curdir/tools/$_action/$_action ]]; then
                $_curdir/tools/$_action/$_action "$@"
            # 有目录工具，目录与工具名不同名，不支持直接执行
            elif [[ -d $_curdir/tools/$_action ]]; then
                echo "Tool List:"
                _list=`find $_curdir/tools/$_action/ -maxdepth 1 -perm -111 -type f`
                cecho g "$_list"
            else
                usage
                exit 1
            fi
            ;;
    esac
fi
