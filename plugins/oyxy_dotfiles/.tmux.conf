# -- 1) 通用配置 -------------------------------------------------------------

# terminal/input behavior
setw -g xterm-keys on
set -s escape-time 0
set -sg repeat-time 250
set -s focus-events on
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'

# true color support
set -g default-terminal "tmux-256color"
set -as terminal-features ",*:RGB"

# interaction/session lifecycle
set -g mouse on
set -sg exit-empty on
set -g detach-on-destroy off
set -g allow-passthrough on

# notifications/history
set -g visual-activity off
setw -g monitor-activity off
setw -g monitor-bell off
set -g history-limit 100000

# key tables
set -g status-keys emacs
set -g mode-keys vi

# reload configuration
bind r source-file ~/.tmux.conf \; display '~/.tmux.conf sourced'

# propagate environment variables into tmux
set -ga update-environment '\
DISPLAY DBUS_SESSION_BUS_ADDRESS \
QT_IM_MODULE QT_QPA_PLATFORMTHEME \
SESSION_MANAGER \
XDG_CONFIG_HOME XDG_CACHE_HOME XDG_DATA_HOME\
XDG_MENU_PREFIX XDG_RUNTIME_DIR XDG_SESSION_CLASS \
XDG_SESSION_DESKTOP XDG_SESSION_TYPE XDG_CURRENT_DESKTOP \
XMODIFIERS \
FZF_DEFAULT_OPTS \
TERM TERM_PROGRAM \
'


# -- 2) 快捷键映射 -----------------------------------------------------------

# prefix
unbind C-b
set -g prefix M-e
bind M-e send-prefix

# display helpers
set -g display-panes-time 2000
set -g display-time 2000
bind -n M-` display-panes

# create/split/kill
bind C-c new-session
bind -n M-= new-window -c '#{pane_current_path}' -a
bind -n M-O break-pane
bind -n M-- kill-pane
bind _ split-window -v -c '#{pane_current_path}'
bind | split-window -h -c '#{pane_current_path}'
bind -n M-f resize-pane -Z

# rename prompts
bind . command-prompt -p "Rename session to:" "run-shell \"~/.config/tmux/scripts/rename_session_prompt.sh '%%'\""
unbind ,
bind , command-prompt -p "Rename window:" "rename-window '%%'"

# window navigation keys
unbind n
unbind p
unbind 1
unbind 2
unbind 3
unbind 4
unbind 5
unbind 6
unbind 7
unbind 8
unbind 9
unbind 0
unbind x
unbind d
bind -n M-w select-window -n
bind -n M-q select-window -p
bind -n M-\\ select-window -l

# join pane into indexed windows
bind -n M-! join-pane -t :1
bind -n M-@ join-pane -t :2
bind -n 'M-#' join-pane -t :3
bind -n 'M-$' join-pane -t :4
bind -n M-% join-pane -t :5
bind -n M-^ join-pane -t :6
bind -n M-& join-pane -t :7
bind -n M-* join-pane -t :8
bind -n M-( join-pane -t :9

# move current window to target session index
bind 1 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 1"
bind 2 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 2"
bind 3 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 3"
bind 4 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 4"
bind 5 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 5"
bind 6 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 6"
bind 7 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 7"
bind 8 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 8"
bind 9 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 9"
bind 0 run-shell "~/.config/tmux/scripts/move_window_to_session.sh 10"

# pane navigation/resizing/layout
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R
bind Space run-shell "~/.config/tmux/scripts/toggle_orientation.sh"
bind W choose-tree -Z
bind S choose-tree 'move-pane -v -s "%%"'
bind V choose-tree 'move-pane -h -s "%%"'
bind -n M-N resize-pane -L 3
bind -n M-E resize-pane -D 3
bind -n M-U resize-pane -U 3
bind -n M-I resize-pane -R 3

# copy mode and buffers
bind -n M-c copy-mode
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe 'pbcopy'
bind-key -T copy-mode-vi - send-keys -X start-of-line
bind-key -T copy-mode-vi = send-keys -X end-of-line
bind-key -T copy-mode-vi w send-keys -X next-space
bind-key -T copy-mode-vi W send-keys -X next-word
bind-key -T copy-mode-vi e send-keys -X next-space-end
bind-key -T copy-mode-vi E send-keys -X next-word-end
bind-key -T copy-mode-vi b send-keys -X previous-space
bind-key -T copy-mode-vi B send-keys -X previous-word
bind-key -T copy-mode-vi j send-keys -X cursor-down
bind-key -T copy-mode-vi k send-keys -X cursor-up
bind-key -T copy-mode-vi h send-keys -X cursor-left
bind-key -T copy-mode-vi l send-keys -X cursor-right
bind b list-buffers
bind p paste-buffer


# -- 3) Session 配置 ---------------------------------------------------------

# hooks (unset before setting to avoid duplicates on reload)
set-hook -gu client-attached
set-hook -ag client-attached 'run -b "tmux refresh-client -S"'

set-hook -gu session-created
set-hook -ag session-created 'run -b "~/.config/tmux/scripts/session_created.sh"'
set-hook -ag session-created 'run -b "tmux refresh-client -S"'

set-hook -gu session-renamed
set-hook -g session-renamed 'run -b "tmux refresh-client -S"'

set-hook -gu session-closed
set-hook -ag session-closed 'run -b "python3 ~/.config/tmux/scripts/session_manager.py ensure"'
set-hook -ag session-closed 'run -b "tmux refresh-client -S"'

# trigger once at startup
run-shell "~/.config/tmux/scripts/session_created.sh"

# session index switching
unbind -n F1
unbind -n F2
unbind -n F3
unbind -n F4
unbind -n F5
unbind -n F6
unbind -n F7
unbind -n F8
unbind -n F9
unbind -n F10
unbind -n F11
unbind -n F12
bind -n F9 send-keys F9
bind -n F12 send-keys F12
bind -n M-F1 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 1"
bind -n M-F2 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 2"
bind -n M-F3 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 3"
bind -n M-F4 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 4"
bind -n M-F5 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 5"
bind -n M-F6 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 6"
bind -n M-F7 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 7"
bind -n M-F8 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 8"
bind -n M-F9 run-shell -b "~/.config/tmux/scripts/switch_session_by_index.sh 9"


# -- 4) Window 配置 ----------------------------------------------------------

set -g base-index 1
setw -g automatic-rename on
set -g renumber-windows on
set -g set-titles on

# status line
set -g status-position top
set -g status-justify left
set -g status-left-length 90
set -g status-right-length 140
set -g status-bg black
set -g status-style "bg=black,fg=colour250"
set -g status-interval 10
setw -g window-status-separator ' '
setw -g window-status-style "fg=colour250,bg=colour240"
setw -g window-status-activity-style bg=black
setw -g window-status-bell-style bg=black
setw -g window-status-current-style "fg=#1A1B26,bold"
setw -g window-status-current-format '#[fg=#E0AF68,bg=black]#[fg=#1A1B26,bg=#E0AF68,bold]#I#(~/.config/tmux/tmux-status/codex_pane_suffix.sh window "#{window_id}")#(~/.config/tmux/tmux-status/window_task_icon.sh "#{window_id}")#[fg=#E0AF68,bg=black]'
setw -g window-status-format '#[fg=colour250,bg=colour240] #I#(~/.config/tmux/tmux-status/codex_pane_suffix.sh window "#{window_id}")#(~/.config/tmux/tmux-status/window_task_icon.sh "#{window_id}") '

set-option -g status-left "#(~/.config/tmux/tmux-status/left.sh '#{session_id}')"
set-option -g status-right "#(~/code/apikey_balance/tmux_balance_monitor)"

# project-specific window activation hooks
set-hook -gu after-select-window
set-hook -ag after-select-window 'run -b "~/.config/tmux/tmux-status/ack_on_pane_focus.sh '\''#{pane_id}'\'' '\''#{window_id}'\'' '\''#{session_id}'\''"'
set-hook -ag after-select-window 'run -b "tmux refresh-client -S"'
set-hook -gu after-new-window
set-hook -ag after-new-window 'run -b "tmux refresh-client -S"'
set-hook -gu window-unlinked
set-hook -ag window-unlinked 'run -b "tmux refresh-client -S"'

# window swaps
bind -n M-l swap-window -d -t :-1
bind -n M-y swap-window -d -t :+1


# -- 5) Pane 配置 ------------------------------------------------------------

setw -g pane-base-index 1

# pane hooks
set-hook -gu after-select-pane
set-hook -ag after-select-pane 'run -b "~/.config/tmux/tmux-status/ack_on_pane_focus.sh '\''#{pane_id}'\'' '\''#{window_id}'\'' '\''#{session_id}'\''"'
set-hook -ag after-select-pane 'run -b "tmux refresh-client -S"'

set-hook -gu pane-died
set-hook -ag pane-died 'run -b "tmux refresh-client -S"'
set-hook -gu pane-exited
set-hook -ag pane-exited 'run -b "tmux refresh-client -S"'
set-hook -gu after-split-window
set-hook -ag after-split-window 'run -b "tmux refresh-client -S"'
set-hook -gu after-kill-pane
set-hook -ag after-kill-pane 'run -b "tmux refresh-client -S"'

# pane style
set -g @theme_color "#AF0000"
run-shell "~/.config/tmux/scripts/update_theme_color.sh"
setw -g pane-border-status top
set -g pane-scrollbars off
set -g pane-scrollbars-position right
set -g pane-border-style fg=blue
set -g pane-active-border-style fg=red
setw -g pane-border-format '#(~/.config/tmux/scripts/pane_border_format.sh "#{pane_active}" "#{@theme_color}" "#{pane_pid}" "#{pane_width}" "#{pane_current_path}" "#{pane_current_command}" "#{window_zoomed_flag}" "#{pane_id}" "#{window_id}")'
set -g pane-border-indicators both
set -g pane-border-lines heavy

# toggle synchronized input
bind C-g if-shell '[[ $(tmux showw synchronize-panes | cut -d\  -f2) == "on" ]]' \
'setw synchronize-panes off; set -g pane-border-style fg=blue; set -g pane-active-border-style fg=red' \
'setw synchronize-panes on; set -g pane-border-style fg=blue; set -g pane-active-border-style fg=red'


# -- 6) 其他外部插件与脚本集成 -----------------------------------------------

# agent-tracker integrations
bind -n M-t run-shell "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command toggle --client '#{client_tty}' || true"
bind -n M-m run-shell "test -f ~/.config/agent-tracker/scripts/focus_latest_notified.sh && bash ~/.config/agent-tracker/scripts/focus_latest_notified.sh || true"
bind -n M-M run-shell "test -f ~/.config/agent-tracker/scripts/focus_last_origin.sh && bash ~/.config/agent-tracker/scripts/focus_last_origin.sh || true"

# layout helper scripts
bind -n M-S run-shell "~/.config/tmux/scripts/new_session.sh"
bind I run-shell "~/.config/tmux/scripts/layout_builder.sh right"
bind N run-shell "~/.config/tmux/scripts/layout_builder.sh left"
bind U run-shell "~/.config/tmux/scripts/layout_builder.sh up"
bind E run-shell "~/.config/tmux/scripts/layout_builder.sh down"
