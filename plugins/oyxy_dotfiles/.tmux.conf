######################
# general
######################
set -g xterm-keys on
set -g display-panes-time 3000
set -g base-index 1
set -s focus-events on
set -s extended-keys on
#set -g window-active-style fg=default,bg=colour8
#set -g window-style fg=default,bg=colour8
#set -g window-style fg=default,bg=black
bind r source-file ~/.tmux.conf \; display-message "Config reloaded..." \;
set -g renumber-windows on
set -g history-limit 100000
set -g mouse on
set -g allow-passthrough on
setw -g automatic-rename on
set -g renumber-windows on

set -q -g status-utf8 on
setw -q -g utf8 on

set -g visual-activity off
setw -g monitor-activity off
setw -g monitor-bell off

# it is terrible for using vim
set -g escape-time 0

set -ga update-environment '\
DISPLAY DBUS_SESSION_BUS_ADDRESS \
QT_IM_MODULE QT_QPA_PLATFORMTHEME \
SESSION_MANAGER \
XDG_CONFIG_HOME XDG_CACHE_HOME XDG_DATA_HOME\
XDG_MENU_PREFIX XDG_RUNTIME_DIR XDG_SESSION_CLASS \
XDG_SESSION_DESKTOP XDG_SESSION_TYPE XDG_CURRENT_DESKTOP \
XMODIFIERS \
FZF_DEFAULT_OPTS \
TMUX_THEME_COLOR \
TERM TERM_PROGRAM \
'

######################
# Hooks (unset before setting to avoid duplicates on reload)
######################
set-hook -gu client-attached
set-hook -g client-attached 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command acknowledge --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
set-hook -ag client-attached 'run -b "tmux refresh-client -S"'

set-hook -gu pane-focus-in
set-hook -g pane-focus-in "run -b 'bash ~/.config/tmux/fzf_panes.tmux update_mru_pane_ids'"
set-hook -ag pane-focus-in 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command acknowledge --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
set-hook -ag pane-focus-in 'run -b "tmux refresh-client -S"'

set-hook -gu pane-died
set-hook -g pane-died 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command delete_task --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'
set-hook -ag pane-died 'run -b "test -x ~/.config/agent-tracker/bin/tracker-client && ~/.config/agent-tracker/bin/tracker-client command note_archive_pane --client #{client_tty} --session-id #{session_id} --window-id #{window_id} --pane #{pane_id} || true"'

# -- Project-specific window activation hooks
# Checks for ./on-tmux-window-activate.sh or ../on-tmux-window-activate.sh and runs it
set-hook -gu after-select-window
set-hook -g after-select-window 'run-shell "~/.config/tmux/scripts/check_and_run_on_activate.sh \"#{pane_current_path}\""'

# set-hook -ag window-linked 'run -b "tmux refresh-client -S"'
# set-hook -ag window-unlinked 'run -b "tmux refresh-client -S"'
# set-hook -ag window-renamed 'run -b "tmux refresh-client -S"'
# set-hook -ag window-layout-changed 'run -b "tmux refresh-client -S"'
# set-hook -ag after-kill-window 'run -b "tmux refresh-client -S"'
#
# set-hook -gu client-session-changed
# set-hook -g client-session-changed 'run -b "tmux refresh-client -S"'
#
set-hook -gu session-created
set-hook -ag session-created 'run -b "~/.config/tmux/scripts/session_created.sh"'
set-hook -ag session-created 'run -b "tmux refresh-client -S"'

set-hook -gu session-renamed
set-hook -g session-renamed 'run -b "tmux refresh-client -S"'

set-hook -gu session-closed
set-hook -g session-closed 'run -b "tmux refresh-client -S"'

run-shell "~/.config/tmux/scripts/session_created.sh"

######################
# session
######################
bind C-c new-session
bind -n M-S run-shell "~/.config/tmux/scripts/new_session.sh"
bind -n F1 break-pane

######################
# pane
######################
run-shell "~/.config/tmux/scripts/update_theme_color.sh"
setw -g pane-border-status top
set -g pane-scrollbars off
set -g pane-scrollbars-position right
set -g pane-active-border-style fg=#b294bb
set -g pane-border-style fg=colour244
setw -g pane-border-format '#{?pane_active, #[fg=#{@theme_color}]#[bg=#{@theme_color}]#[fg=#1d1f21]#[bold] #{?window_zoomed_flag,⛶ ,} #(~/.config/tmux/scripts/pane_starship_title.sh #{pane_pid} #{pane_width} "#{pane_current_path}" "#{pane_current_command}") #[bg=default]#[fg=#{@theme_color}]#[default], #[fg=colour244]#[bg=colour244]#[fg=#1d1f21] #{?window_zoomed_flag,⛶ ,} #(~/.config/tmux/scripts/pane_starship_title.sh #{pane_pid} #{pane_width} "#{pane_current_path}" "#{pane_current_command}") #[bg=default]#[fg=colour244]#[default] }'
#set -g pane-active-border-style fg=brightblue
#set -g pane-border-style fg=magenta

# pane title
set -g pane-base-index 1
set -g pane-border-indicators both
set -g pane-border-lines heavy

# -- toggle_syn_input
bind C-g if-shell '[[ $(tmux showw synchronize-panes | cut -d\  -f2) == "on" ]]' \
'setw synchronize-panes off; set -g pane-border-style fg=#{?#{!=:#{environ:TMUX_THEME_COLOR},},#{environ:TMUX_THEME_COLOR},#b294bb}' \
'setw synchronize-panes on; set -g pane-border-style fg=red'

bind C-g if-shell '[ "$(tmux showw -v synchronize-panes)" = "on" ]' \
  'setw synchronize-panes off; ' \
  'setw synchronize-panes on; set -g pane-border-style fg=red'
#set -g pane-border-style fg=#{?#{!=:#{environ:TMUX_THEME_COLOR},},#{environ:TMUX_THEME_COLOR},#b294bb}


######################
# status bar
######################
set -g status-position bottom
set -g status on
set -g status-style "bg=colour103,fg=colour232"
set -g status-justify centre
set -g status-keys vi
set -g status-left-length 90
set -g status-right-length 90
# 短间隔和powerline对cpu开销都有点大
set -g status-interval 10
#set -g status-left '#(~/.tmux-powerline/powerline.sh left) #{?client_prefix,  #[reverse bold] PREFIX ,}'
#set -g status-right "#(~/.tmux-powerline/powerline.sh right)"
#set -g status-left '#(/Volumes/code/awesome_devops/plugins/oyxy_dotfiles/tmux_status_get_balance/main.sh) #{?client_prefix,  #[reverse bold] PREFIX ,}'
set -g status-left ''
#set -g status-right "#(date '+%m-%d %H:%M:%S')"
set -g status-right ""
setw -g window-status-current-style "fg=colour15,bg=colour124 underscore bold"
setw -g window-status-current-format ' #I '
setw -g window-status-format ' #I '

######################
# vim
######################
#set -g default-command "reattach-to-user-namespace -l ${SHELL}"
#set -g  set-clipboard on

bind-key -T copy-mode-vi 'v' send-keys -X begin-selection
bind-key -T copy-mode-vi 'y' send-keys -X copy-pipe-and-cancel 'reattach-to-user-namespace pbcopy'
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe 'reattach-to-user-namespace pbcopy'
bind-key -T copy-mode-vi - send-keys -X start-of-line
bind-key -T copy-mode-vi = send-keys -X end-of-line
bind-key -T copy-mode-vi w send-keys -X next-space
bind-key -T copy-mode-vi W send-keys -X next-word
bind-key -T copy-mode-vi e send-keys -X next-space-end
bind-key -T copy-mode-vi E send-keys -X next-word-end
bind-key -T copy-mode-vi b send-keys -X previous-space
bind-key -T copy-mode-vi B send-keys -X previous-word
bind-key -T copy-mode-vi j send-keys -X cursor-down
bind-key -T copy-mode-vi k send-keys -X cursor-up
bind-key -T copy-mode-vi h send-keys -X cursor-left
bind-key -T copy-mode-vi l send-keys -X cursor-right

# Copy-paste integration
#set-option -g default-command "reattach-to-user-namespace -l bash"

# Use vim keybindings in copy mode
setw -g mode-keys vi

######################
# general key map
######################
set -g repeat-time 250
set -g prefix M-e
unbind-key C-b
bind M-e send-prefix
bind -n M-` display-panes
bind -n M-1 select-window -t :1
bind -n M-2 select-window -t :2
bind -n M-3 select-window -t :3
bind -n M-4 select-window -t :4
bind -n M-w select-window -n #next-window
bind -n M-q select-window -p #previous-window
bind -n M-\\ select-window -l
bind -n M-= new-window -c '#{pane_current_path}' -a

bind -n M-- kill-pane
bind -n M-c copy-mode
unbind x
unbind d
bind _ split-window -v -c '#{pane_current_path}'
bind | split-window -h -c '#{pane_current_path}'
bind space select-layout even-horizontal
bind -r h select-pane -L  # move left
bind -r j select-pane -D  # move down
bind -r k select-pane -U  # move up
bind -r l select-pane -R  # move right

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# Other examples:
# set -g @plugin 'github_username/plugin_name'
# set -g @plugin 'git@github.com/user/plugin'
# set -g @plugin 'git@bitbucket.com/user/plugin'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
#run -b '~/.tmux/plugins/tpm/tpm'
